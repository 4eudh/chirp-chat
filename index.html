<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatApp - Modern Messaging</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#25D366',
                        primaryDark: '#128C7E',
                        secondary: '#34B7F1',
                        dark: '#111B21',
                        darkSecondary: '#202C33',
                        darkTertiary: '#2A3942'
                    }
                }
            }
        }
    </script>
    <style>
        .message-bubble {
            max-width: 80%;
            word-wrap: break-word;
        }
        .typing-dots {
            animation: typing 1.4s infinite;
        }
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }
        .scroll-smooth { scroll-behavior: smooth; }
        .emoji-picker {
            display: none;
            position: absolute;
            bottom: 100%;
            right: 0;
            background: white;
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 8px;
            z-index: 1000;
            max-height: 200px;
            overflow-y: auto;
        }
        .dark .emoji-picker {
            background: #2A3942;
            border-color: #404040;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-dark min-h-screen">
    <!-- Authentication Modal -->
    <div id="authModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white dark:bg-darkSecondary rounded-lg p-8 max-w-md w-full mx-4">
            <div class="text-center mb-6">
                <i class="fas fa-comments text-primary text-4xl mb-2"></i>
                <h1 class="text-2xl font-bold text-gray-800 dark:text-white">ChatApp</h1>
                <p class="text-gray-600 dark:text-gray-400">Connect with friends instantly</p>
            </div>

            <!-- Login Form -->
            <div id="loginForm">
                <h2 class="text-xl font-semibold mb-4 text-gray-800 dark:text-white">Sign In</h2>
                <form id="loginFormElement" class="space-y-4">
                    <input type="email" id="loginEmail" placeholder="Email" required
                           class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-darkTertiary text-gray-800 dark:text-white text-base">
                    <input type="password" id="loginPassword" placeholder="Password" required
                           class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-darkTertiary text-gray-800 dark:text-white text-base">
                    <button type="submit" class="w-full bg-primary hover:bg-primaryDark text-white p-3 rounded-lg font-semibold transition-colors">
                        Sign In
                    </button>
                </form>
                <p class="text-center mt-4 text-gray-600 dark:text-gray-400">
                    Don't have an account? 
                    <button id="showRegister" class="text-primary hover:underline">Sign Up</button>
                </p>
            </div>

            <!-- Register Form -->
            <div id="registerForm" class="hidden">
                <h2 class="text-xl font-semibold mb-4 text-gray-800 dark:text-white">Create Account</h2>
                <form id="registerFormElement" class="space-y-4">
                    <input type="text" id="registerFullName" placeholder="Full Name" required
                           class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-darkTertiary text-gray-800 dark:text-white text-base">
                    <input type="text" id="registerUsername" placeholder="Username" required
                           class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-darkTertiary text-gray-800 dark:text-white text-base">
                    <input type="email" id="registerEmail" placeholder="Email" required
                           class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-darkTertiary text-gray-800 dark:text-white text-base">
                    <input type="password" id="registerPassword" placeholder="Password" required
                           class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-darkTertiary text-gray-800 dark:text-white text-base">
                    <button type="submit" class="w-full bg-primary hover:bg-primaryDark text-white p-3 rounded-lg font-semibold transition-colors">
                        Create Account
                    </button>
                </form>
                <p class="text-center mt-4 text-gray-600 dark:text-gray-400">
                    Already have an account? 
                    <button id="showLogin" class="text-primary hover:underline">Sign In</button>
                </p>
            </div>

            <!-- Profile Setup -->
            <div id="profileSetup" class="hidden">
                <h2 class="text-xl font-semibold mb-4 text-gray-800 dark:text-white">Complete Your Profile</h2>
                <form id="profileForm" class="space-y-4">
                    <div class="text-center">
                        <div class="relative inline-block">
                            <img id="avatarPreview" src="https://via.placeholder.com/100" alt="Avatar" 
                                 class="w-20 h-20 rounded-full mx-auto mb-2">
                            <label for="avatarInput" class="absolute bottom-0 right-0 bg-primary text-white rounded-full w-6 h-6 flex items-center justify-center cursor-pointer">
                                <i class="fas fa-camera text-xs"></i>
                            </label>
                            <input type="file" id="avatarInput" accept="image/*" class="hidden">
                        </div>
                    </div>
                    <textarea id="profileBio" placeholder="Write something about yourself..." 
                              class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-darkTertiary text-gray-800 dark:text-white text-base resize-none h-20"></textarea>
                    <button type="submit" class="w-full bg-primary hover:bg-primaryDark text-white p-3 rounded-lg font-semibold transition-colors">
                        Complete Setup
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Main Chat Interface -->
    <div id="chatApp" class="hidden h-screen flex">
        <!-- Sidebar -->
        <div class="w-full md:w-1/3 lg:w-1/4 bg-white dark:bg-darkSecondary border-r border-gray-200 dark:border-gray-700 flex flex-col">
            <!-- Header -->
            <div class="p-4 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <img id="userAvatar" src="" alt="Profile" class="w-10 h-10 rounded-full">
                    <div>
                        <h3 id="userName" class="font-semibold text-gray-800 dark:text-white"></h3>
                        <span id="userStatus" class="text-sm text-gray-500">Online</span>
                    </div>
                </div>
                <div class="flex space-x-2">
                    <button id="newChatBtn" class="p-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-darkTertiary rounded-full">
                        <i class="fas fa-plus"></i>
                    </button>
                    <button id="settingsBtn" class="p-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-darkTertiary rounded-full">
                        <i class="fas fa-cog"></i>
                    </button>
                </div>
            </div>

            <!-- Search -->
            <div class="p-4">
                <div class="relative">
                    <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    <input type="text" id="searchInput" placeholder="Search conversations..." 
                           class="w-full pl-10 pr-4 py-2 bg-gray-100 dark:bg-darkTertiary border-none rounded-lg text-gray-800 dark:text-white text-base">
                </div>
            </div>

            <!-- Conversations List -->
            <div id="conversationsList" class="flex-1 overflow-y-auto">
                <!-- Conversations will be loaded here -->
            </div>
        </div>

        <!-- Chat Area -->
        <div class="flex-1 flex flex-col">
            <!-- Chat Header -->
            <div id="chatHeader" class="hidden p-4 bg-white dark:bg-darkSecondary border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <button id="backBtn" class="md:hidden p-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-darkTertiary rounded-full">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <img id="chatAvatar" src="" alt="Chat" class="w-10 h-10 rounded-full">
                    <div>
                        <h3 id="chatName" class="font-semibold text-gray-800 dark:text-white"></h3>
                        <span id="chatStatus" class="text-sm text-gray-500"></span>
                    </div>
                </div>
                <div class="flex space-x-2">
                    <button class="p-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-darkTertiary rounded-full">
                        <i class="fas fa-phone"></i>
                    </button>
                    <button class="p-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-darkTertiary rounded-full">
                        <i class="fas fa-video"></i>
                    </button>
                    <button id="chatMenuBtn" class="p-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-darkTertiary rounded-full">
                        <i class="fas fa-ellipsis-v"></i>
                    </button>
                </div>
            </div>

            <!-- Welcome Screen -->
            <div id="welcomeScreen" class="flex-1 flex items-center justify-center bg-gray-50 dark:bg-dark">
                <div class="text-center">
                    <i class="fas fa-comments text-primary text-6xl mb-4"></i>
                    <h2 class="text-2xl font-semibold text-gray-800 dark:text-white mb-2">Welcome to ChatApp</h2>
                    <p class="text-gray-600 dark:text-gray-400">Select a conversation to start chatting</p>
                </div>
            </div>

            <!-- Messages Area -->
            <div id="messagesArea" class="hidden flex-1 overflow-y-auto p-4 bg-gray-50 dark:bg-dark scroll-smooth">
                <div id="messagesList" class="space-y-2 w-full">
                    <!-- Messages will be loaded here -->
                </div>
            </div>

            <!-- Typing Indicator -->
            <div id="typingIndicator" class="hidden px-4 py-2 bg-gray-50 dark:bg-dark">
                <div class="flex items-center space-x-2 text-gray-500">
                    <div class="typing-dots">●</div>
                    <div class="typing-dots" style="animation-delay: 0.2s;">●</div>
                    <div class="typing-dots" style="animation-delay: 0.4s;">●</div>
                    <span id="typingText" class="text-sm ml-2">Someone is typing...</span>
                </div>
            </div>

            <!-- Message Input -->
            <div id="messageInput" class="hidden p-4 bg-white dark:bg-darkSecondary border-t border-gray-200 dark:border-gray-700">
                <div class="flex items-end space-x-2">
                    <button id="attachBtn" class="p-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-darkTertiary rounded-full">
                        <i class="fas fa-paperclip"></i>
                    </button>
                    <div class="flex-1 relative">
                        <textarea id="messageTextarea" placeholder="Type a message..." 
                                  class="w-full p-3 pr-12 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-darkTertiary text-gray-800 dark:text-white text-base resize-none min-h-[44px] max-h-32"></textarea>
                        <button id="emojiBtn" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600">
                            <i class="fas fa-smile"></i>
                        </button>
                        <div id="emojiPicker" class="emoji-picker">
                            <div class="grid grid-cols-8 gap-1">
                                <span class="cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 p-1 rounded">😀</span>
                                <span class="cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 p-1 rounded">😂</span>
                                <span class="cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 p-1 rounded">❤️</span>
                                <span class="cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 p-1 rounded">👍</span>
                                <span class="cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 p-1 rounded">👎</span>
                                <span class="cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 p-1 rounded">😢</span>
                                <span class="cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 p-1 rounded">😡</span>
                                <span class="cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 p-1 rounded">🎉</span>
                            </div>
                        </div>
                    </div>
                    <button id="sendBtn" class="p-2 bg-primary hover:bg-primaryDark text-white rounded-full transition-colors">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
                
                <!-- Reply Preview -->
                <div id="replyPreview" class="hidden mt-2 p-2 bg-gray-100 dark:bg-darkTertiary rounded border-l-4 border-primary">
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="text-sm font-medium text-gray-800 dark:text-white" id="replyToUser"></div>
                            <div class="text-sm text-gray-600 dark:text-gray-400" id="replyToMessage"></div>
                        </div>
                        <button id="cancelReply" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- New Chat Modal -->
    <div id="newChatModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white dark:bg-darkSecondary rounded-lg p-6 max-w-md w-full mx-4">
            <h2 class="text-xl font-semibold mb-4 text-gray-800 dark:text-white">Start New Chat</h2>
            <div class="space-y-4">
                <input type="text" id="newChatSearch" placeholder="Search users..." 
                       class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-darkTertiary text-gray-800 dark:text-white text-base">
                <div id="usersList" class="max-h-60 overflow-y-auto space-y-2">
                    <!-- Users will be loaded here -->
                </div>
                <div class="flex justify-end space-x-3">
                    <button id="cancelNewChat" class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded">Cancel</button>
                    <button id="createGroupBtn" class="px-4 py-2 bg-primary text-white rounded hover:bg-primaryDark">Create Group</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Context Menu -->
    <div id="messageContextMenu" class="hidden fixed bg-white dark:bg-darkSecondary border border-gray-200 dark:border-gray-700 rounded-lg shadow-lg z-50 py-2">
        <button class="w-full px-4 py-2 text-left hover:bg-gray-100 dark:hover:bg-darkTertiary text-gray-800 dark:text-white" data-action="reply">
            <i class="fas fa-reply mr-2"></i>Reply
        </button>
        <button class="w-full px-4 py-2 text-left hover:bg-gray-100 dark:hover:bg-darkTertiary text-gray-800 dark:text-white" data-action="forward">
            <i class="fas fa-share mr-2"></i>Forward
        </button>
        <button class="w-full px-4 py-2 text-left hover:bg-gray-100 dark:hover:bg-darkTertiary text-gray-800 dark:text-white" data-action="react">
            <i class="fas fa-heart mr-2"></i>React
        </button>
        <button class="w-full px-4 py-2 text-left hover:bg-gray-100 dark:hover:bg-darkTertiary text-gray-800 dark:text-white" data-action="delete">
            <i class="fas fa-trash mr-2"></i>Delete
        </button>
    </div>

    <script>
        // Supabase Configuration - REPLACE WITH YOUR ACTUAL CREDENTIALS
        const SUPABASE_URL = 'https://pmaocaggftemdfbqbpri.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBtYW9jYWdnZnRlbWRmYnFicHJpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ4MzQ1NjAsImV4cCI6MjA3MDQxMDU2MH0.EBtC7cCHQ9M4O3KrircHy6NY2arhtxcgBBXag7ni94A';
        
        // Initialize Supabase client
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Global variables
        let currentUser = null;
        let currentConversation = null;
        let conversations = [];
        let messages = [];
        let users = [];
        let replyingTo = null;
        let typingTimeout = null;
        let messagesSubscription = null;
        let typingSubscription = null;

        // Dark mode setup
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        // Initialize app
        document.addEventListener('DOMContentLoaded', async () => {
            // Check if user is already authenticated
            const { data: { user } } = await supabase.auth.getUser();
            if (user) {
                currentUser = user;
                await loadUserProfile();
                showChatApp();
            } else {
                showAuthModal();
            }

            setupEventListeners();
        });

        function setupEventListeners() {
            // Auth form listeners
            document.getElementById('loginFormElement').addEventListener('submit', handleLogin);
            document.getElementById('registerFormElement').addEventListener('submit', handleRegister);
            document.getElementById('profileForm').addEventListener('submit', handleProfileSetup);
            document.getElementById('showRegister').addEventListener('click', () => toggleAuthForm('register'));
            document.getElementById('showLogin').addEventListener('click', () => toggleAuthForm('login'));

            // Chat listeners
            document.getElementById('sendBtn').addEventListener('click', sendMessage);
            document.getElementById('messageTextarea').addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            document.getElementById('messageTextarea').addEventListener('input', handleTyping);
            document.getElementById('newChatBtn').addEventListener('click', showNewChatModal);
            document.getElementById('emojiBtn').addEventListener('click', toggleEmojiPicker);
            document.getElementById('cancelReply').addEventListener('click', cancelReply);
            document.getElementById('backBtn').addEventListener('click', () => {
                document.getElementById('chatApp').querySelector('.w-full.md\\:w-1\\/3').classList.remove('hidden');
                document.querySelector('.flex-1.flex.flex-col').classList.add('hidden');
            });

            // Modal listeners
            document.getElementById('cancelNewChat').addEventListener('click', hideNewChatModal);
            document.getElementById('createGroupBtn').addEventListener('click', createGroup);

            // Avatar upload
            document.getElementById('avatarInput').addEventListener('change', handleAvatarUpload);

            // Context menu
            document.addEventListener('click', hideContextMenu);
            document.addEventListener('contextmenu', handleRightClick);

            // Emoji picker
            document.getElementById('emojiPicker').addEventListener('click', (e) => {
                if (e.target.tagName === 'SPAN') {
                    insertEmoji(e.target.textContent);
                }
            });

            // Search functionality
            document.getElementById('searchInput').addEventListener('input', handleSearch);
            document.getElementById('newChatSearch').addEventListener('input', handleUserSearch);
        }

        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            try {
                const { data, error } = await supabase.auth.signInWithPassword({ email, password });
                
                if (error) throw error;

                currentUser = data.user;
                await updateUserStatus('online');
                await loadUserProfile();
                showChatApp();
            } catch (error) {
                showCustomAlert('Login failed: ' + error.message);
            }
        }

async function handleRegister(e) {
    e.preventDefault(); // Make sure to prevent default form submission
    const fullName = document.getElementById('registerFullName').value;
    const username = document.getElementById('registerUsername').value;
    const email = document.getElementById('registerEmail').value;
    const password = document.getElementById('registerPassword').value;

    try {
        const { data, error } = await supabase.auth.signUp({ 
            email, 
            password,
            options: {
                data: {
                    full_name: fullName,
                    username: username
                }
            }
        });
        
        if (error) throw error;

        if (data.user) {
            currentUser = data.user;
            toggleAuthForm('profile');
        }
    } catch (error) {
        console.error('Registration error:', error);
        showCustomAlert('Registration failed: ' + error.message);
    }
}
        async function handleProfileSetup(e) {
            e.preventDefault();
            const bio = document.getElementById('profileBio').value;
            const avatarFile = document.getElementById('avatarInput').files[0];
            
            try {
                let avatarUrl = null;

                // Upload avatar if provided
                if (avatarFile) {
                    const fileExt = avatarFile.name.split('.').pop();
                    const fileName = `${currentUser.id}/avatar.${fileExt}`;
                    
                    const { data: uploadData, error: uploadError } = await supabase.storage
                        .from('avatars')
                        .upload(fileName, avatarFile, { upsert: true });

                    if (uploadError) throw uploadError;

                    const { data: urlData } = supabase.storage
                        .from('avatars')
                        .getPublicUrl(fileName);
                    
                    avatarUrl = urlData.publicUrl;
                }

                // Create user profile
                const { error } = await supabase.from('users').insert({
                    id: currentUser.id,
                    username: currentUser.user_metadata.username,
                    full_name: currentUser.user_metadata.full_name,
                    bio: bio || '',
                    avatar_url: avatarUrl,
                    status: 'online'
                });

                if (error) throw error;

                await loadUserProfile();
                showChatApp();
            } catch (error) {
                showCustomAlert('Profile setup failed: ' + error.message);
            }
        }

        function toggleAuthForm(form) {
            document.getElementById('loginForm').classList.toggle('hidden', form !== 'login');
            document.getElementById('registerForm').classList.toggle('hidden', form !== 'register');
            document.getElementById('profileSetup').classList.toggle('hidden', form !== 'profile');
        }

        function showAuthModal() {
            document.getElementById('authModal').classList.remove('hidden');
            document.getElementById('chatApp').classList.add('hidden');
        }

        async function showChatApp() {
            document.getElementById('authModal').classList.add('hidden');
            document.getElementById('chatApp').classList.remove('hidden');
            
            await loadConversations();
            await loadUsers();
            setupRealtime();
        }

        async function loadUserProfile() {
            try {
                const { data, error } = await supabase
                    .from('users')
                    .select('*')
                    .eq('id', currentUser.id)
                    .single();

                if (error && error.code !== 'PGRST116') throw error;

                if (data) {
                    document.getElementById('userName').textContent = data.full_name || 'User';
                    document.getElementById('userAvatar').src = data.avatar_url || 'https://via.placeholder.com/40';
                }
            } catch (error) {
                console.error('Error loading user profile:', error);
            }
        }

        async function updateUserStatus(status) {
            try {
                await supabase
                    .from('users')
                    .update({ 
                        status: status,
                        last_seen: status === 'offline' ? new Date().toISOString() : null
                    })
                    .eq('id', currentUser.id);
            } catch (error) {
                console.error('Error updating user status:', error);
            }
        }

        async function loadConversations() {
            try {
                const { data, error } = await supabase
                    .from('conversations')
                    .select(`
                        *,
                        conversation_participants!inner(
                            user_id,
                            last_read_at,
                            is_muted,
                            is_archived,
                            role
                        )
                    `)
                    .eq('conversation_participants.user_id', currentUser.id)
                    .order('updated_at', { ascending: false });

                if (error) throw error;

                conversations = data || [];
                await renderConversations();
            } catch (error) {
                console.error('Error loading conversations:', error);
            }
        }

        async function renderConversations() {
            const conversationsList = document.getElementById('conversationsList');
            conversationsList.innerHTML = '';

            for (const conv of conversations) {
                const convElement = document.createElement('div');
                convElement.className = 'p-4 border-b border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-darkTertiary cursor-pointer';
                convElement.onclick = () => selectConversation(conv.id);
                
                // Get display info for conversation
                const displayInfo = await getConversationDisplayInfo(conv);
                
                convElement.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <div class="relative">
                            <img src="${displayInfo.avatar}" alt="${displayInfo.name}" class="w-12 h-12 rounded-full">
                            ${conv.type === 'direct' ? '<div class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 rounded-full border-2 border-white dark:border-darkSecondary"></div>' : ''}
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex justify-between items-center">
                                <h4 class="font-semibold text-gray-800 dark:text-white truncate">${displayInfo.name}</h4>
                                <span class="text-xs text-gray-500">${formatTime(new Date(conv.updated_at))}</span>
                            </div>
                            <div class="flex justify-between items-center mt-1">
                                <p class="text-sm text-gray-600 dark:text-gray-400 truncate">${displayInfo.lastMessage}</p>
                                ${displayInfo.unreadCount > 0 ? `<span class="bg-primary text-white text-xs rounded-full px-2 py-1 min-w-[20px] text-center">${displayInfo.unreadCount}</span>` : ''}
                            </div>
                        </div>
                    </div>
                `;
                
                conversationsList.appendChild(convElement);
            }
        }

        async function getConversationDisplayInfo(conversation) {
            let name = conversation.name;
            let avatar = conversation.avatar_url || 'https://via.placeholder.com/40';
            let lastMessage = '';
            let unreadCount = 0;

            // For direct conversations, get other user's info
            if (conversation.type === 'direct') {
                try {
                    const { data: otherUser } = await supabase
                        .from('users')
                        .select('full_name, avatar_url')
                        .neq('id', currentUser.id)
                        .in('id', conversation.conversation_participants.map(p => p.user_id))
                        .single();

                    if (otherUser) {
                        name = otherUser.full_name;
                        avatar = otherUser.avatar_url || 'https://via.placeholder.com/40';
                    }
                } catch (error) {
                    console.error('Error getting other user info:', error);
                }
            }

            // Get last message
            try {
                const { data: lastMsg } = await supabase
                    .from('messages')
                    .select('content, sender_id, created_at, users(full_name)')
                    .eq('conversation_id', conversation.id)
                    .eq('is_deleted', false)
                    .order('created_at', { ascending: false })
                    .limit(1)
                    .single();

                if (lastMsg) {
                    const senderName = lastMsg.sender_id === currentUser.id ? 'You' : lastMsg.users?.full_name || 'Someone';
                    lastMessage = `${senderName}: ${lastMsg.content}`;
                }
            } catch (error) {
                console.error('Error getting last message:', error);
            }

            // Get unread count
            try {
                const userParticipant = conversation.conversation_participants.find(p => p.user_id === currentUser.id);
                if (userParticipant) {
                    const { count } = await supabase
                        .from('messages')
                        .select('*', { count: 'exact', head: true })
                        .eq('conversation_id', conversation.id)
                        .neq('sender_id', currentUser.id)
                        .eq('is_deleted', false)
                        .gt('created_at', userParticipant.last_read_at);

                    unreadCount = count || 0;
                }
            } catch (error) {
                console.error('Error getting unread count:', error);
            }

            return { name, avatar, lastMessage, unreadCount };
        }

        async function selectConversation(conversationId) {
            currentConversation = conversations.find(c => c.id === conversationId);
            if (!currentConversation) return;

            // Hide sidebar on mobile
            if (window.innerWidth < 768) {
                document.getElementById('chatApp').querySelector('.w-full.md\\:w-1\\/3').classList.add('hidden');
                document.querySelector('.flex-1.flex.flex-col').classList.remove('hidden');
            }

            // Show chat interface
            document.getElementById('welcomeScreen').classList.add('hidden');
            document.getElementById('chatHeader').classList.remove('hidden');
            document.getElementById('messagesArea').classList.remove('hidden');
            document.getElementById('messageInput').classList.remove('hidden');

            // Update header
            const displayInfo = await getConversationDisplayInfo(currentConversation);
            document.getElementById('chatName').textContent = displayInfo.name;
            document.getElementById('chatAvatar').src = displayInfo.avatar;
            document.getElementById('chatStatus').textContent = currentConversation.type === 'direct' ? 'Online' : `${await getGroupMemberCount(conversationId)} members`;

            // Load messages
            await loadMessages(conversationId);
            
            // Mark messages as read
            await markMessagesAsRead(conversationId);

            // Setup real-time subscriptions for this conversation
            setupConversationRealtime(conversationId);
        }

        async function loadMessages(conversationId) {
            try {
                const { data, error } = await supabase
                    .from('messages')
                    .select(`
                        *,
                        users(full_name, avatar_url),
                        message_reactions(emoji, user_id)
                    `)
                    .eq('conversation_id', conversationId)
                    .eq('is_deleted', false)
                    .order('created_at', { ascending: true });

                if (error) throw error;

                messages = data || [];
                renderMessages();
                scrollToBottom();
            } catch (error) {
                console.error('Error loading messages:', error);
            }
        }

        function renderMessages() {
            const messagesList = document.getElementById('messagesList');
            messagesList.innerHTML = '';

            messages.forEach((message, index) => {
                const messageElement = createMessageElement(message, index);
                messagesList.appendChild(messageElement);
            });
        }

        async function createMessageElement(message, index) {
            const isOwn = message.sender_id === currentUser.id;
            const showAvatar = !isOwn && (index === 0 || messages[index - 1].sender_id !== message.sender_id);
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex ${isOwn ? 'justify-end' : 'justify-start'} mb-2`;
            messageDiv.setAttribute('data-message-id', message.id);

            const bubbleClass = isOwn 
                ? 'bg-primary text-white rounded-l-lg rounded-br-lg' 
                : 'bg-white dark:bg-darkSecondary text-gray-800 dark:text-white rounded-r-lg rounded-bl-lg border border-gray-200 dark:border-gray-600';

            // Group reactions by emoji
            const reactionsMap = {};
            message.message_reactions.forEach(reaction => {
                if (!reactionsMap[reaction.emoji]) {
                    reactionsMap[reaction.emoji] = { count: 0, users: [] };
                }
                reactionsMap[reaction.emoji].count++;
                reactionsMap[reaction.emoji].users.push(reaction.user_id);
            });

            const reactions = Object.entries(reactionsMap).map(([emoji, data]) => ({
                emoji,
                count: data.count,
                users: data.users
            }));

            messageDiv.innerHTML = `
                <div class="flex ${isOwn ? 'flex-row-reverse' : 'flex-row'} items-end space-x-2 max-w-xs md:max-w-sm lg:max-w-md">
                    ${showAvatar && !isOwn ? `<img src="${message.users?.avatar_url || 'https://via.placeholder.com/32'}" alt="${message.users?.full_name}" class="w-8 h-8 rounded-full">` : '<div class="w-8"></div>'}
                    <div class="message-bubble ${bubbleClass} p-3 shadow-sm">
                        ${message.reply_to ? `<div class="border-l-4 border-gray-300 pl-2 mb-2 text-sm opacity-75">${await getReplyPreview(message.reply_to)}</div>` : ''}
                        ${message.forwarded_from ? '<div class="text-xs opacity-75 mb-1"><i class="fas fa-share"></i> Forwarded</div>' : ''}
                        <div class="message-content">${formatMessageContent(message.content, message.message_type)}</div>
                        <div class="flex items-center justify-between mt-1">
                            <span class="text-xs opacity-75">${formatTime(new Date(message.created_at))}</span>
                            ${isOwn ? '<i class="fas fa-check-double text-xs opacity-75"></i>' : ''}
                        </div>
                        ${reactions.length > 0 ? `<div class="flex flex-wrap gap-1 mt-2">${renderReactions(reactions)}</div>` : ''}
                    </div>
                </div>
            `;

            // Add context menu listener
            messageDiv.addEventListener('contextmenu', (e) => handleMessageRightClick(e, message));
            
            return messageDiv;
        }

        function formatMessageContent(content, type) {
            if (type === 'text') {
                return content.replace(/\n/g, '<br>');
            } else if (type === 'image') {
                return `<img src="${content}" alt="Image" class="max-w-full h-auto rounded">`;
            } else if (type === 'file') {
                return `<div class="flex items-center space-x-2 p-2 bg-gray-100 dark:bg-gray-700 rounded">
                    <i class="fas fa-file"></i>
                    <span>${content}</span>
                </div>`;
            }
            return content;
        }

        function renderReactions(reactions) {
            return reactions.map(reaction => 
                `<span class="bg-gray-100 dark:bg-gray-700 px-2 py-1 rounded-full text-xs cursor-pointer hover:bg-gray-200 dark:hover:bg-gray-600" onclick="toggleReaction('${reaction.emoji}', '${currentConversation.id}')">
                    ${reaction.emoji} ${reaction.count}
                </span>`
            ).join('');
        }

        async function sendMessage() {
            const textarea = document.getElementById('messageTextarea');
            const content = textarea.value.trim();
            
            if (!content || !currentConversation) return;

            try {
                const { data, error } = await supabase.from('messages').insert({
                    conversation_id: currentConversation.id,
                    sender_id: currentUser.id,
                    content: content,
                    message_type: 'text',
                    reply_to: replyingTo
                }).select('*, users(full_name, avatar_url)').single();

                if (error) throw error;

                // Clear input and reply
                textarea.value = '';
                cancelReply();
                
                // Update conversation timestamp
                await supabase
                    .from('conversations')
                    .update({ updated_at: new Date().toISOString() })
                    .eq('id', currentConversation.id);

                // Clear typing indicator
                await clearTypingIndicator();

                // Scroll to bottom after message is added by real-time subscription
                setTimeout(scrollToBottom, 100);

            } catch (error) {
                console.error('Error sending message:', error);
                showCustomAlert('Failed to send message');
            }
        }

        async function handleTyping() {
            if (!currentConversation) return;

            try {
                // Show typing indicator
                await supabase.from('typing_indicators').upsert({
                    conversation_id: currentConversation.id,
                    user_id: currentUser.id
                });

                // Clear existing timeout
                clearTimeout(typingTimeout);
                
                // Set timeout to remove typing indicator
                typingTimeout = setTimeout(async () => {
                    await clearTypingIndicator();
                }, 3000);
            } catch (error) {
                console.error('Error handling typing:', error);
            }
        }

        async function clearTypingIndicator() {
            if (!currentConversation) return;

            try {
                await supabase
                    .from('typing_indicators')
                    .delete()
                    .eq('conversation_id', currentConversation.id)
                    .eq('user_id', currentUser.id);
            } catch (error) {
                console.error('Error clearing typing indicator:', error);
            }
        }

        async function markMessagesAsRead(conversationId) {
            try {
                // Update last_read_at for the user in this conversation
                await supabase
                    .from('conversation_participants')
                    .update({ last_read_at: new Date().toISOString() })
                    .eq('conversation_id', conversationId)
                    .eq('user_id', currentUser.id);

                // Refresh conversations list to update unread counts
                await loadConversations();
            } catch (error) {
                console.error('Error marking messages as read:', error);
            }
        }

        async function loadUsers() {
            try {
                const { data, error } = await supabase
                    .from('users')
                    .select('id, username, full_name, avatar_url, status')
                    .neq('id', currentUser.id)
                    .order('full_name');

                if (error) throw error;

                users = data || [];
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }

        function showNewChatModal() {
            document.getElementById('newChatModal').classList.remove('hidden');
            renderUsersList();
        }

        function hideNewChatModal() {
            document.getElementById('newChatModal').classList.add('hidden');
        }

        function renderUsersList(searchTerm = '') {
            const usersList = document.getElementById('usersList');
            usersList.innerHTML = '';

            const filteredUsers = users.filter(user => 
                user.full_name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                user.username.toLowerCase().includes(searchTerm.toLowerCase())
            );

            filteredUsers.forEach(user => {
                const userElement = document.createElement('div');
                userElement.className = 'flex items-center space-x-3 p-2 hover:bg-gray-100 dark:hover:bg-darkTertiary rounded cursor-pointer';
                userElement.onclick = () => startDirectChat(user);
                
                userElement.innerHTML = `
                    <img src="${user.avatar_url || 'https://via.placeholder.com/40'}" alt="${user.full_name}" class="w-10 h-10 rounded-full">
                    <div>
                        <h4 class="font-medium text-gray-800 dark:text-white">${user.full_name}</h4>
                        <p class="text-sm text-gray-600 dark:text-gray-400">@${user.username}</p>
                    </div>
                    <div class="ml-auto">
                        <span class="w-3 h-3 rounded-full ${user.status === 'online' ? 'bg-green-500' : 'bg-gray-400'}"></span>
                    </div>
                `;
                
                usersList.appendChild(userElement);
            });
        }

        async function startDirectChat(user) {
            try {
                // Use the create_direct_conversation function
                const { data, error } = await supabase.rpc('create_direct_conversation', {
                    user1_id: currentUser.id,
                    user2_id: user.id
                });

                if (error) throw error;

                // Reload conversations and select the new/existing one
                await loadConversations();
                selectConversation(data);
                hideNewChatModal();
            } catch (error) {
                console.error('Error starting direct chat:', error);
                showCustomAlert('Failed to start chat');
            }
        }

        async function createGroup() {
            showCustomPrompt('Enter group name:', async (groupName) => {
                if (groupName) {
                    try {
                        const { data, error } = await supabase.from('conversations').insert({
                            name: groupName,
                            type: 'group',
                            created_by: currentUser.id
                        }).select().single();

                        if (error) throw error;

                        // Add creator as admin
                        await supabase.from('conversation_participants').insert({
                            conversation_id: data.id,
                            user_id: currentUser.id,
                            role: 'admin'
                        });

                        await loadConversations();
                        selectConversation(data.id);
                        hideNewChatModal();
                    } catch (error) {
                        console.error('Error creating group:', error);
                        showCustomAlert('Failed to create group');
                    }
                }
            });
        }

        async function toggleReaction(emoji, messageId) {
            try {
                // Check if user already reacted with this emoji
                const { data: existingReaction } = await supabase
                    .from('message_reactions')
                    .select('id')
                    .eq('message_id', messageId)
                    .eq('user_id', currentUser.id)
                    .eq('emoji', emoji)
                    .single();

                if (existingReaction) {
                    // Remove reaction
                    await supabase
                        .from('message_reactions')
                        .delete()
                        .eq('id', existingReaction.id);
                } else {
                    // Add reaction
                    await supabase.from('message_reactions').insert({
                        message_id: messageId,
                        user_id: currentUser.id,
                        emoji: emoji
                    });
                }
            } catch (error) {
                console.error('Error toggling reaction:', error);
            }
        }

        function setupRealtime() {
            // Listen for auth state changes
            supabase.auth.onAuthStateChange(async (event, session) => {
                if (event === 'SIGNED_OUT') {
                    showAuthModal();
                } else if (event === 'SIGNED_IN') {
                    currentUser = session.user;
                    await updateUserStatus('online');
                }
            });

            // Listen for new conversations
            supabase
                .channel('conversations')
                .on('postgres_changes', 
                    { event: '*', schema: 'public', table: 'conversations' },
                    () => loadConversations()
                )
                .subscribe();

            // Update user status to offline when page is closed
            window.addEventListener('beforeunload', async () => {
                if (currentUser) {
                    await updateUserStatus('offline');
                }
            });
        }

        function setupConversationRealtime(conversationId) {
            // Clean up existing subscriptions
            if (messagesSubscription) {
                messagesSubscription.unsubscribe();
            }
            if (typingSubscription) {
                typingSubscription.unsubscribe();
            }

            // Listen for new messages in this conversation
            messagesSubscription = supabase
                .channel(`messages:${conversationId}`)
                .on('postgres_changes', 
                    { 
                        event: '*', 
                        schema: 'public', 
                        table: 'messages',
                        filter: `conversation_id=eq.${conversationId}`
                    },
                    async (payload) => {
                        if (payload.eventType === 'INSERT') {
                            await loadMessages(conversationId);
                            scrollToBottom();
                        } else if (payload.eventType === 'UPDATE') {
                            await loadMessages(conversationId);
                        } else if (payload.eventType === 'DELETE') {
                            await loadMessages(conversationId);
                        }
                    }
                )
                .subscribe();

            // Listen for message reactions
            supabase
                .channel(`reactions:${conversationId}`)
                .on('postgres_changes', 
                    { event: '*', schema: 'public', table: 'message_reactions' },
                    async () => {
                        await loadMessages(conversationId);
                    }
                )
                .subscribe();

            // Listen for typing indicators
            typingSubscription = supabase
                .channel(`typing:${conversationId}`)
                .on('postgres_changes', 
                    { 
                        event: '*', 
                        schema: 'public', 
                        table: 'typing_indicators',
                        filter: `conversation_id=eq.${conversationId}`
                    },
                    async (payload) => {
                        await updateTypingIndicator(conversationId);
                    }
                )
                .subscribe();
        }

        async function updateTypingIndicator(conversationId) {
            try {
                const { data, error } = await supabase
                    .from('typing_indicators')
                    .select('*, users(full_name)')
                    .eq('conversation_id', conversationId)
                    .neq('user_id', currentUser.id)
                    .gte('created_at', new Date(Date.now() - 30000).toISOString());

                if (error) throw error;

                const typingIndicator = document.getElementById('typingIndicator');
                const typingText = document.getElementById('typingText');

                if (data && data.length > 0) {
                    const typingUsers = data.map(t => t.users.full_name).join(', ');
                    typingText.textContent = `${typingUsers} ${data.length === 1 ? 'is' : 'are'} typing...`;
                    typingIndicator.classList.remove('hidden');
                } else {
                    typingIndicator.classList.add('hidden');
                }
            } catch (error) {
                console.error('Error updating typing indicator:', error);
            }
        }

        async function getGroupMemberCount(conversationId) {
            try {
                const { count, error } = await supabase
                    .from('conversation_participants')
                    .select('*', { count: 'exact', head: true })
                    .eq('conversation_id', conversationId);

                if (error) throw error;
                return count || 0;
            } catch (error) {
                console.error('Error getting member count:', error);
                return 0;
            }
        }

        function handleSearch(e) {
            const searchTerm = e.target.value.toLowerCase();
            const conversationElements = document.querySelectorAll('#conversationsList > div');
            
            conversationElements.forEach(element => {
                const name = element.querySelector('h4').textContent.toLowerCase();
                const lastMessage = element.querySelector('p').textContent.toLowerCase();
                
                if (name.includes(searchTerm) || lastMessage.includes(searchTerm)) {
                    element.style.display = 'block';
                } else {
                    element.style.display = 'none';
                }
            });
        }

        function handleUserSearch(e) {
            const searchTerm = e.target.value;
            renderUsersList(searchTerm);
        }

        function toggleEmojiPicker() {
            const picker = document.getElementById('emojiPicker');
            picker.style.display = picker.style.display === 'block' ? 'none' : 'block';
        }

        function insertEmoji(emoji) {
            const textarea = document.getElementById('messageTextarea');
            textarea.value += emoji;
            document.getElementById('emojiPicker').style.display = 'none';
            textarea.focus();
        }

        function handleMessageRightClick(e, message) {
            e.preventDefault();
            showContextMenu(e.clientX, e.clientY, message);
        }

        function handleRightClick(e) {
            const messageElement = e.target.closest('[data-message-id]');
            if (messageElement) {
                e.preventDefault();
                const messageId = messageElement.getAttribute('data-message-id');
                const message = messages.find(m => m.id === messageId);
                if (message) {
                    showContextMenu(e.clientX, e.clientY, message);
                }
            }
        }

        function showContextMenu(x, y, message) {
            const menu = document.getElementById('messageContextMenu');
            menu.style.left = x + 'px';
            menu.style.top = y + 'px';
            menu.classList.remove('hidden');
            
            menu.onclick = (e) => {
                const action = e.target.closest('button')?.getAttribute('data-action');
                if (action) {
                    handleContextMenuAction(action, message);
                    hideContextMenu();
                }
            };
        }

        function hideContextMenu() {
            document.getElementById('messageContextMenu').classList.add('hidden');
        }

        async function handleContextMenuAction(action, message) {
            switch (action) {
                case 'reply':
                    startReply(message);
                    break;
                case 'forward':
                    forwardMessage(message);
                    break;
                case 'react':
                    await toggleReaction('❤️', message.id);
                    break;
                case 'delete':
                    deleteMessage(message);
                    break;
            }
        }

        function startReply(message) {
            replyingTo = message.id;
            document.getElementById('replyPreview').classList.remove('hidden');
            document.getElementById('replyToUser').textContent = message.users?.full_name || 'User';
            document.getElementById('replyToMessage').textContent = message.content;
            document.getElementById('messageTextarea').focus();
        }

        function cancelReply() {
            replyingTo = null;
            document.getElementById('replyPreview').classList.add('hidden');
        }

        function forwardMessage(message) {
            showCustomConfirm('Forward this message?', () => {
                showCustomAlert('Message forwarding will be implemented in future version');
            });
        }

        async function deleteMessage(message) {
            showCustomConfirm('Delete this message?', async () => {
                try {
                    await supabase
                        .from('messages')
                        .update({ is_deleted: true })
                        .eq('id', message.id);
                } catch (error) {
                    console.error('Error deleting message:', error);
                    showCustomAlert('Failed to delete message');
                }
            });
        }

        async function handleAvatarUpload(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('avatarPreview').src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }

        async function getReplyPreview(replyToId) {
            try {
                const { data, error } = await supabase
                    .from('messages')
                    .select('content, users(full_name)')
                    .eq('id', replyToId)
                    .single();

                if (error) throw error;
                return `${data.users?.full_name || 'User'}: ${data.content.substring(0, 50)}${data.content.length > 50 ? '...' : ''}`;
            } catch (error) {
                return 'Original message';
            }
        }

        // Utility functions
        function formatTime(date) {
            const now = new Date();
            const diff = now - date;
            
            if (diff < 60000) return 'now';
            if (diff < 3600000) return Math.floor(diff / 60000) + 'm';
            if (diff < 86400000) return Math.floor(diff / 3600000) + 'h';
            return Math.floor(diff / 86400000) + 'd';
        }

        function scrollToBottom() {
            const messagesArea = document.getElementById('messagesArea');
            messagesArea.scrollTop = messagesArea.scrollHeight;
        }

        // Custom dialog functions
        function showCustomAlert(message) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-darkSecondary p-6 rounded-lg shadow-lg max-w-sm w-full mx-4">
                    <p class="text-gray-700 dark:text-gray-300 mb-4">${message}</p>
                    <div class="flex justify-end">
                        <button class="px-4 py-2 bg-primary text-white hover:bg-primaryDark rounded" onclick="this.closest('.fixed').remove()">OK</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function showCustomConfirm(message, onConfirm) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-darkSecondary p-6 rounded-lg shadow-lg max-w-sm w-full mx-4">
                    <p class="text-gray-700 dark:text-gray-300 mb-4">${message}</p>
                    <div class="flex justify-end space-x-3">
                        <button class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded" onclick="this.closest('.fixed').remove()">Cancel</button>
                        <button class="px-4 py-2 bg-primary text-white hover:bg-primaryDark rounded" onclick="this.closest('.fixed').remove(); onConfirm()">Confirm</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function showCustomPrompt(message, onConfirm) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-darkSecondary p-6 rounded-lg shadow-lg max-w-sm w-full mx-4">
                    <p class="text-gray-700 dark:text-gray-300 mb-4">${message}</p>
                    <input type="text" id="promptInput" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-darkTertiary text-gray-800 dark:text-white text-base mb-4">
                    <div class="flex justify-end space-x-3">
                        <button class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded" onclick="this.closest('.fixed').remove()">Cancel</button>
                        <button class="px-4 py-2 bg-primary text-white hover:bg-primaryDark rounded" onclick="const value = this.parentElement.parentElement.querySelector('#promptInput').value; this.closest('.fixed').remove(); if(value) onConfirm(value);">OK</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            setTimeout(() => document.getElementById('promptInput').focus(), 100);
        }
    </script>
</body>
</html>
